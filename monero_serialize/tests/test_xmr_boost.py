#!/usr/bin/env python
# -*- coding: utf-8 -*-
import random
import base64
import unittest
import binascii
import json
import pkg_resources

import asyncio
import aiounittest

from .test_data import XmrTestData
from .. import xmrserialize as x
from .. import xmrtypes as xmr
from .. import xmrboost as xmrb
from .. import xmrobj as xmro
from .. import xmrjson as xmrjs


__author__ = 'dusanklinec'


class XmrBoostTest(aiounittest.AsyncTestCase):
    """Simple tests"""

    def __init__(self, *args, **kwargs):
        super(XmrBoostTest, self).__init__(*args, **kwargs)
        self.test_data = XmrTestData()

    def setUp(self):
            self.test_data.reset()

    async def test_simple_msg(self):
        """
        TxinGen
        :return:
        """
        data_hex = b'011673657269616c697a6174696f6e3a3a61726368697665000000000134'
        data_bin = base64.b16decode(data_hex, True)
        reader = x.MemoryReaderWriter(bytearray(data_bin))
        ar = xmrb.Archive(reader, False)

        msg = xmr.TxinGen()
        await ar.root_message(msg)
        self.assertEqual(msg.height, 0x34)

    async def test_ctkey_msg(self):
        """
        CtKey
        :return:
        """
        data_hex = b'011673657269616c697a6174696f6e3a3a617263686976650000000000000120000000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000000'
        data_bin = base64.b16decode(data_hex, True)
        reader = x.MemoryReaderWriter(bytearray(data_bin))
        ar = xmrb.Archive(reader, False)

        msg = xmr.CtKey()
        await ar.root_message(msg)

    async def test_destination_entries(self):
        """
        Tx destinations, two records, versioning test.
        :return:
        """
        data_hex = b'011673657269616c697a6174696f6e3a3a6172636869766500000001010144000000000120cc000000000000000000000000000000000000000000000000000000000000ee0120aa000000000000000000000000000000000000000000000000000000000000dd01010122012011000000000000000000000000000000000000000000000000000000000000ee012033000000000000000000000000000000000000000000000000000000000000dd00'
        data_bin = base64.b16decode(data_hex, True)
        reader = x.MemoryReaderWriter(bytearray(data_bin))
        ar = xmrb.Archive(reader, False)

        msg = xmr.TxDestinationEntry()
        await ar.root_message(msg)

        self.assertEqual(msg.amount, 0x44)
        self.assertEqual(msg.is_subaddress, 1)
        self.assertEqual(msg.addr.m_spend_public_key, bytearray(b'\xcc' + (b'\x00' * 30) + b'\xee'))
        self.assertEqual(msg.addr.m_view_public_key, bytearray(b'\xaa' + (b'\x00' * 30) + b'\xdd'))

        msg2 = xmr.TxDestinationEntry()
        await ar.message(msg2)

        self.assertEqual(msg2.amount, 0x22)
        self.assertEqual(msg2.is_subaddress, 0)
        self.assertEqual(msg2.addr.m_spend_public_key, bytearray(b'\x11' + (b'\x00' * 30) + b'\xee'))
        self.assertEqual(msg2.addr.m_view_public_key, bytearray(b'\x33' + (b'\x00' * 30) + b'\xdd'))

    async def test_tx_prefix(self):
        """
        Tx destinations, two records, versioning test.
        :return:
        """
        data_hex = b'011673657269616c697a6174696f6e3a3a617263686976650000000001020000000101000000010300000001070002bd02021e01012402000101ed019b01380000012001000000000000000000000000000000000000000000000000000000000000000000010200000000000001020000000001208829dedf62f2c7e6b21556daed786143fb4c1c3ff95bde568b82860229c44b17000102012098d2c70dcef9fc62378ed2d49301a800f90cd8c9423c2b08dfef5f9635267978012c000209012f3413399032aeea0173e1bdbff7ceb9f62089f1cd1163aa48e2226ce9077d5abe11ce95cad8f34e0d'
        data_bin = base64.b16decode(data_hex, True)
        reader = x.MemoryReaderWriter(bytearray(data_bin))
        ar = xmrb.Archive(reader, False)

        msg = xmr.TransactionPrefix()
        await ar.root()
        await ar.message(msg)
        self.assertEqual(msg.version, 2)
        self.assertEqual(msg.unlock_time, 0)
        self.assertEqual(len(msg.vin), 1)
        self.assertEqual(len(msg.vout), 2)
        self.assertEqual(len(msg.extra), 44)
        self.assertEqual(msg.vin[0].amount, 0)
        self.assertEqual(len(msg.vin[0].key_offsets), 7)
        self.assertEqual(msg.vin[0].key_offsets[6], 56)
        self.assertEqual(msg.vout[0].amount, 0)
        self.assertEqual(msg.vout[1].amount, 0)
        self.assertEqual(msg.vout[0].target.key,
                         binascii.unhexlify(b'8829dedf62f2c7e6b21556daed786143fb4c1c3ff95bde568b82860229c44b17'))
        self.assertEqual(msg.vout[1].target.key,
                         binascii.unhexlify(b'98d2c70dcef9fc62378ed2d49301a800f90cd8c9423c2b08dfef5f9635267978'))
        self.assertEqual(msg.extra, [ 2, 9, 1, 47, 52, 19, 57, 144, 50, 174, 234, 1, 115, 225, 189, 191, 247, 206, 185, 246, 32, 137, 241, 205, 17, 99, 170, 72, 226, 34, 108, 233, 7, 125, 90, 190, 17, 206, 149, 202, 216, 243, 78, 13])

    async def test_tx(self):
        """
        Full transaction
        :return:
        """
        data_hex = b'011673657269616c697a6174696f6e3a3a617263686976650000000001020000000101000000010300000001070002bd02021e01012402000101ed019b01380000012001000000000000000000000000000000000000000000000000000000000000000000010200000000000001020000000001208829dedf62f2c7e6b21556daed786143fb4c1c3ff95bde568b82860229c44b17000102012098d2c70dcef9fc62378ed2d49301a800f90cd8c9423c2b08dfef5f9635267978012c000209012f3413399032aeea0173e1bdbff7ceb9f62089f1cd1163aa48e2226ce9077d5abe11ce95cad8f34e0d000001000001020000000000012003ad3d029bb61e93576eb6635e4fb47898649b106451199df7df7d2294559f0a01205401ebaedf70b3530e6614e9305f42b85599677511d0c055842af635deed9400012028853eebcbe5b5a2d8caba7f84c9015cd061b7a8d44ea3cf275d44e5a014790b012098e1b80d7cdfd09d1ddec9ed81480a7be94bd5c2b4a54c91bea163110fffe40100000102000120feacdfcf14afdb38ff62464148af427dadbfddd9fe9207e4c1cd8700d8a5c50601204908ea58bad7ed52bd70cc201eaae6280d833226bce333b16672c30ad91f9b430570938a1f0200000000010200000000000140012052d28e6915f507fb9677495e66d5e096611267bd3e37a7d5cd08cbff92db480a01206146b5999049d5f680b22b2e2c1d2f4d5686ffd979d9840ae1fb5a613c74e9090120f71e3e5bc9a1972571fb7ce5b5a79c09cdf1eefc955984facae756bea5e1e90d01200b31d9e85673167a9982c42baba416e8fbca716f3af07645bd7d94bb0ef9cd030120faca69fcdc868076b46c9889e3eca48cdf6607a683a708060fa06ac980e3c10a0120c99eb71d91fa8f2b0196b35f4315dcbf019440dc899689fee4297db9b05ebe0e01205b8be1a002757c83485f49f587760e8578a46c0c55f50b59fe4d23736dc7b60301203540b286a8c0427bdb4350ef036a66669e87dbb56ed458cf5073d36ccabd370e0120ccb4b9b2414a0a430f9eeb0816bebd62b68852be5d372d4b7f4036e8dbe4bf0801201b1805977d440f47bd854c911d6f48d35e66a0dc3f59f83037e1aedf80b020000120ea8516221d5b688fa102b065546bab6662fa18c9ad207d76e93cf33c4e25ab030120329c5e7307fa13ee4e231eba357f4c228aaf275b1eb575248d7535e535aa85050120e2392c419af41223a2249fd544b08c61833411b82261e9fc1dde4997a8947e0201202d45d3c57ea2b4bcac25c072122e8907147eb1ddae54ced727c58e24dc84b40201204772ce61015ee7d6f5e2aa564551d57fcb2d670a1390c2fce959545fd28c360101202c9e54d490a096df3a1a2fa40a4ccf416e916343c7444e203e61bbcd37ba340d0120266e83e661091cb2e231084b2c3df9d9bc87cb49bce5dddbe60a1327776e0c030120e1939d37ebbfcbb64994618ef60e3c580ee700ec1cdc4f0fad468326212dfe09012061726eeaec2901390bd96d84a204b3ff1aa2bdb571b73b32e3cf2e850863370701206ab25bef7875a6d3aa9a05a016f7782544da3510048ffb6559d4421731f392070120ee674e966c0790e15aa35873752ce4c4a32b6fcc82e2c8aaff1eb9b602c3c50001206362d92ed82da9c7e906970e420ca7a92d31096e9cdfe6e5ff00e5991f81cd0b01201e9eb218a46f8bc7906d30a4e350046cb3b81bc9568fec1954a2bb7ac7b38f010120216f5a0481d22facac5474f3a5998fb3becab275138702f9c1945fa44fc0d50501200d34faa72dbb26d39d67e0a59f9c6b74edb1d73e70523b8e75b718c9f50f72050120cec38dbefe848211aef553ffadc0c57d44e69d8baa0f76ca61e3668e099e2e01012032e6eb2f63145a870f43aa8ca5c9602b938c391e7a807af2e1e2054e69e1080601205295e6dc7d6a02b2f7e9cdaef26e5c6c82df1fe1095f3ed74378f0a3f07640090120309a6cfd535ae1378620be6620aae96d350c5c7916bac20a53c5116231fa9e0f0120ab112b96b5fdb741d6f762f34ba7a1073d183df5002507ae88ef1de673daa9080120611336daa2a6b560270e7ab30af4eaa555a9d8084eed03e5c024b1c10a6cd50e0120f086e53bafbd2362061b42e9fc5745992e7ba2746b7d92434adff32e51cbd0080120efe9026fa771fa92b0c60365ec8324eed9b017fcf2965cf4e1c931a22afd02000120e035cd310c5cf8e480ff8cba312133eec8b77e08a354917ebf0867c94bb7070b0120df236343432ae638cecde9b2d847f92a069b2d663b45f027356d4bce43eb5c020120923aa57f1061a69f9b544f00c928c3c8753b67db6ec448ccb999b2dc38d43f00012057fa503544abe06eaef29aa9e6fa86b224258193cd4d527f7e4185ef9337ad0801207876ddba74fbc191a7c172a59d82f088b29036824585192f2f473b15eae8c90f01209d244708054977a4a3f429c52662ac3f103b770cf79161961f5ff4e7c0fff8010120619a0e9b3ceaa0f2e61df0428023dab4ef607a3b45e70b9dd196f770e0c2be08012083550ed736f64546952b7dbdc16f8949baa896bde0a8d70d26fc96506804400b0120396fe156d1a93951dd9110c7510b7a516f836734a9e49c3e2d537ad160580a0c01205be5a973f038adcc1a3be0c49a2ffd10ddc9c25fa7f8c9b8014dc37962b40c0e0120ab8ee706c111975f88006e705c1b420048343dc651b9070229094ce3a8db750e01202622204fa07e92ec3c9a6b19972f6e6621e4c1e3ddcea16cd976971c938a2d070120a8d05744964540831d03ecd59fff33e9c1fca0609b4046f2c2ee97f4071e560201205b91f141095a34c5d8e2c789f97d37ab890f610316e4c46d48f10e70af151f0f0120cdb99bb68032d2267ef87de35ea7288eb948f93fbe7176a2a4a6c3e3b135e901012004466c48d2d79a683444fd2544b159144b4c04d8149cf618a104bdac13d69501012013a017adba28a59067eca6c376623c8b865566c5199f35c29252bd6d707fac080120b6588ab6d5a387075eb40a618e4b712d0f3f2778fe22763245ccc74c315f66020120bcf7dc3dc691cfcb109a8dbdcdd09d05f89dd0cedea1224ec9e97bce8532990a012090f5e65df3679b9b3e8c8845bf9c614706e34a228160dfe8694cec2237ef5b07012051cfcc9f2142be08dfb502de0a873d857a2dc6fbc4ab55f160fd7e8222bde3010120bc8562eb768a0f748fcb5f26e071f5a055d80c2e6bb7cc9b687c3b98ecb0eb0a0120d2f61ab0246c674d5376896e4c22dddb00af4ddd5b2115912df4fdaf9a12180401204f33c1e14a9c8b20d77a54a941f2620a6cfde7b9cd9dcb2395aa6c88d684050001203ba51030f2748f91b31e8b313fe0365d315cc4770c9645001878d48f4bc6ae030120a91e564d30f181b029e1d9da8f9d8c85a584e61b240ed728a5c47a503c923404012000e44f2e8fda5770720278fda142d67e5b96f49ef513dea2b1f7f2d33c778d0001201bafac668c2f5fa95e7791f5589ff9f17542fff9959853ca8cbcbf759db22b0e0120127442ac8c006733570aa170499918bbcc73132da4e0142af78532c8e4062e0e012014d57afe0a9b4df0e4749711f42a3f8b560b3825cc371c0f9eaee1b9c8711c080120dea7a749c2b3df0f36087a2c75dbd263807baf1b9d77c383228f5bc137ad970d014001204d840f93da77f3164da31655c3ef30fda6f7a6d139f200a1d68be89ea4276a0801202107187c36a96763320ff2574e1384803dd655d8ee230ce9497b26eee322690b01202a8cd54a79d47e3812a1cc0ec2e39e277f8719a8410b78a60ae49632d2b24e0e0120c16055d5af67428e3e335f8a1b5113f91141568ee6af59b2e75f02c2298bb5060120c36721eebd0ecdd537fe0981dd2acc3ee5bd778e83b9a9b6d9cfccbc9db78a090120bd663a877c178fb1ef105bc56fec1119949a5446a2e47026420e0f830231c5030120094568b17f0c8bd728184f829f70f53dca3bf29d4fd2cc2f1fe6aa76c6cf6b08012043403c78ada46c193e207fc53230d25aa3b3ca5197a2ec060b2c18cdd87a03020120558784d2872eebd96bf934f65a871fd54889f7ea1053a1161fbceb605fd4f50b01209cd8b5a14345817b9d6b30444b35199c416d3f1bbf30325193135a1dbaf1fb090120a4711eb5cd4898db4c71474ffc4b11ea11541832921da051d2576eee82ec480701209271adc1f1934340b3528b36f9269274dae0539b7a3958aab9d8b2051a6546010120e0dd133028fd21b0dffe5c51aa739010e671166bed4f0e89b85cd7efaf0f780c01200d15cb7e0395d6f58766a94b753b7fb66f2c30a5f4ec05d4a3bee73c01a4d80901209990d1530c5233d49aec595d7229bc56723e8a57e21dc61424a82f70041c8f0f0120d4b7d1c5812bf52b4c3bbf5852eeb62014bd72e8a0aed3bad057190ecbff04050120439bac6d52a4d35021808c22917c904484cd52f761791f364341fd0a9d79ef09012096e39b6d627e6d3800c5e9421e6ace0528b299a46fdd0a7e1a867652fe8cce0401208bed8bd8db6927f08aa0c1cc12ee04785a28ffbc3dd5f0802c3b3981dfa5860a0120d1bb88410579ea33c0d8411279d5ef88617b584e2fe3a58298db06509cff1b060120166928bb7e86d838f1475b48b9d9f1bd5e20abb6ed2f26d93cde762850cb110c0120a3c8a983d861f0e88c9d7c9e5f124d7453448cdffdc31e315f211d47808b730c012031e7a5b473a4a814f56060696923d3897fcd567b34d5ba7f91468c351e55ac010120b6ad36378421a7a27971843de6d37c80ee74a785d7057f4282bbb2bec97745040120d9e8fa488618d5fbd0f45a2f41b4722b7dfd80fd12aa854ef7ac09e768e59d0e01203e374aae96703a0f4b6e3d1efa8e9e196bafc44222ac7809b9f558b5d16508070120c63f9f53ae736e7a7c2d8fd33b1f7ca01c0321163fae757838920fcfa73f47050120be289452c34c13942c284f5df8d0bb919514b372a2be14ac7ca7a227b804b10a012073cfaf107b6fb001034bdd99583c509a69a3d34d9fa2d0652503742886b8a00f0120488e20e48424498640d9340e6da886fe2f962db367cc04ba93c8dad95c38e10e0120fb4ae9b8f7514bcbcc22fe32d79a4b1d4f48fceaee7eb50b6c9c9287b142b00001204b6ce4d8568a965260033f457437d058f5ba0fe841ed67097930dada5a0b110901202b9f40f8fca4eec185e1af1cbd00ebb2696b73489e31dd57b2bbfc36dea4d60d01203ab0736cd5b5f8c676d3e46ad0873b6a77a56f27fa8a388a7bde38cb403be20d0120011c24c4ff0ed9dd2cfbaed905c8b002a84aa1065ff1e1785cf57a4671a165060120c011dba49a0f9457628771350ee67f7238ba0de81be7d0f15d74ce000f9ed20c0120c96a62f62c47e2fc8f350a9f120316997e24cdb3865c5d69dafc3ee428f00e010120286f48c9f4a4ae26a3972f1b59ddf0d50a7aec754b81f72950e03da5fd78f90e0120f120fc1874bd711fd7bdbea8ee0314499220ad0a3ce5698721717e653286dc0f012005a05ca0faeacfaafb6f75672be21a5c0b316685e4dd48c081cd72cc102a1e0f012028cb4cd5ad9545e19d2822810abd50c77ab9ea9fb9fc107b1e84bad3666f1e03012056d46b50b22a6a205b95fd91980c1ef700f851c51506e3aa01f46791cf3dee020120d30d2851c85065efcd182a0db96afbd2e4676fdce2c8473082367106c758a9020120f1a102170956bc5dce8b52b9dcd4bcbb0775835116bfb3d4f468ff69718f81040120c1dacc65b6155fd09de97954c855772fb1a9e444d497d35af817f6764d71170e0120d1c2c59710c38657554ab85848ebca53357a6c9f4c70fa71f2d3e500a836c3090120c46b9b4c18a819a9befd56c3a452f2acddddb310cc11e85498cd9f618305580f0120a96a07b8d48429fc8661e3608193b5f8f068cdf09dfcc672e18f5925156e7b050120332e3a3a32bc5891df25862b879746f0f5eff792a826cd8c0e5997bba701ec010120877a62a48f511304d481894adedcbd8b9535ac0bc63bc1c7e10ba0a3420c610f01200fa5ec800dc455397dd32732b1ebe92a5ce0a7580fc7f89d6c855187b6a70707012036ea26b1e38525feb7a1f60d04ebd3dd78dd906899180afc767611b5b4f6c40a0120139fbfba2035dc491117bcdd3d21deddfc8ce172b7362f877e49b2a5090efa01012001bd610c1908b2add0fd5622d5c953fb3e020972b76d27ab3288490f2737e50a0120f55440ac088211e4ad39fa079cf556804d7858b6ccfe9063788e72c0baf0c3010120094bf276c05895b4652c4cbc9635e346b140443eddb9047da6900656d1e88c0c0120a52542ff1a11cdc56113f8e442891aac0e1f7ef70a6626a5af651fe900463b020120c92156d9ba5b03f831161345976a46b9cdd59618c50c01a83691ef2378e4560f0120ac23391e04aa9e35c56aeef10b411924ca662141651bf7027e790b95e12a390a0120bc10a75a5e427e9303d81b2135b6978f067a5525b3be41112f19e0b3d401b30b0120969ff167a3fbe47ed73bda19fc72b93c2443463aba4c18c7141c8406f4c5df010120676e4d8361c3c6abaaff628e31173251911cdfabcf16af739a05d632fa1c250c01207523de7e68364f21cd14e710ba782529b4f39c4072695d250e940c54bec563070120c69bef2ac49ca00baa3c2b6452384ad7f1969e262cdef4920347fb59a222d40c0120994dda4f135f39a9f62631cf4b019ed0d48a8c27112c167c77fa53da2b628f0e01400120877212f2dffb424edfa4ff5c4cc2f828a28f77cd00bc77384eaf64b8890d7f8a0120c30830757dd68f65f4431ac19f7c7cdaafa320fe238106e92f11a4ff688628510120eada95b1470c735e691f94b56099addecf0621d88e6db71537b24da2df3b6ce401201944c8b03ca0e2a3ae245ebf1559ac3011f25af2fd0d8
        data_bin = base64.b16decode(data_hex, True)
        reader = x.MemoryReaderWriter(bytearray(data_bin))
        ar = xmrb.Archive(reader, False)

        msg = xmr.Transaction()
        await ar.root()
        await ar.message(msg)
        self.assertEqual(msg.version, 2)
        self.assertEqual(msg.unlock_time, 0)
        self.assertEqual(msg.rct_signatures.type, 1)
        self.assertEqual(msg.rct_signatures.txnFee, 9119110000)
        self.assertEqual(msg.rct_signatures.outPk[1].mask,
                         binascii.unhexlify(b'4908ea58bad7ed52bd70cc201eaae6280d833226bce333b16672c30ad91f9b43'))
        self.assertEqual(len(msg.rct_signatures.p.rangeSigs), 2)
        self.assertEqual(len(msg.rct_signatures.p.MGs), 1)
        self.assertEqual(len(msg.rct_signatures.p.MGs[0].ss), 7)
        self.assertEqual(msg.rct_signatures.p.MGs[0].cc,
                         binascii.unhexlify(b'23237696b7cfd0fe1159cfedd00a8acc138ef91f2f249e6289e1f14cb58bce06'))






if __name__ == "__main__":
    unittest.main()  # pragma: no cover



